<?xml version="1.0" encoding="UTF-8"?>
<project name="NextJS type definitions">

    <property name="targetTypeDirectory" value="${basedir}/../../saas/starters/_shared/backend/types" />
    <property name="generatedTypeFile"  value="${basedir}/src/js/types/nextjs/api/index.ts" />

    <target name="nextjs-types:copy" depends="apidocs">
        <copy file="${generatedTypeFile}" todir="${targetTypeDirectory}" />

        <retry retrycount="3" retrydelay="1000">
            <exec executable="git" failonerror="false" dir="${targetTypeDirectory}">
                <arg value="add" />
                <arg value="index.ts" />
            </exec>
        </retry>
    </target>

    <target name="nextjs-types:check" depends="apidocs" extensionOf="-package:before~hook">
        <exec executable="diff" failonerror="false" resultproperty="return.code">
            <arg value="${generatedTypeFile}" />
            <arg value="${targetTypeDirectory}/index.ts" />
        </exec>
        <fail message="Types changed. Please update ${targetTypeDirectory}/index.ts by running 'ant nextjs-types:copy' in paas/catwalk and make sure there are no backwards-compatibility breaking changes.">
            <condition>
                <isfailure code="${return.code}" />
            </condition>
        </fail>
    </target>
</project>
