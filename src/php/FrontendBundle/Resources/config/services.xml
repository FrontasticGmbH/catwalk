<?xml version="1.0" ?>

<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <parameters>
        <parameter key="ssr_port">8000</parameter>
        <parameter key="frontastic.nodejs.renderer">http://localhost:%ssr_port%</parameter>
    </parameters>

    <services>
        <defaults public="true" />

        <prototype namespace="Frontastic\Catwalk\FrontendBundle\Command\" resource="../../Command" autoconfigure="true" />

        <service id="Frontastic\Catwalk\FrontendBundle\Routing\UrlGenerator">
            <argument type="collection">
                <argument
                    key="Frontastic\Common\ProductApiBundle\Domain\Product"
                    type="service"
                    id="Frontastic\Catwalk\FrontendBundle\Routing\ObjectRouter\ProductRouter"
                />
            </argument>

            <tag name="frontastic.json_serializer.enhancer" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Routing\ObjectRouter\ProductRouter">
            <!--
             * IMPORTANT: We must use the container here, otherwise we try to load
             * the ContextService in context free situations.
            -->
            <argument type="service" id="service_container" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\NodeService">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Gateway\NodeGateway" />
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\RouteService" />
        </service>

        <service id="frontastic.catwalk.frontend_bundle.domain.node.replication_target" class="Frontastic\Catwalk\ApiCoreBundle\Domain\EnvironmentReplicationFilter">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\NodeService" />
            <argument type="service" id="Frontastic\Catwalk\ApiCoreBundle\Domain\Context"/>

            <tag name="endpoint.target" channel="nodes" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\PageService">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Gateway\PageGateway" />
        </service>

        <service id="frontastic.catwalk.frontend_bundle.domain.page.replication_target" class="Frontastic\Catwalk\ApiCoreBundle\Domain\EnvironmentReplicationFilter">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\PageService" />
            <argument type="service" id="Frontastic\Catwalk\ApiCoreBundle\Domain\Context"/>

            <tag name="endpoint.target" channel="pages" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\MasterService">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Gateway\MasterPageMatcherRulesGateway" />

            <tag name="endpoint.target" channel="page-matcher" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\FacetService">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Gateway\FacetGateway" />
        </service>

        <service id="frontastic.catwalk.frontend_bundle.domain.facet.replication_target" class="Frontastic\Catwalk\ApiCoreBundle\Domain\EnvironmentReplicationFilter">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\FacetService" />
            <argument type="service" id="Frontastic\Catwalk\ApiCoreBundle\Domain\Context"/>

            <tag name="endpoint.target" channel="facets" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\RedirectService">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Gateway\RedirectGateway" />
            <argument type="service" id="router.default" />
        </service>

        <service id="frontastic.catwalk.frontend_bundle.domain.redirect.replication_target" class="Frontastic\Catwalk\ApiCoreBundle\Domain\EnvironmentReplicationFilter">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\RedirectService" />
            <argument type="service" id="Frontastic\Catwalk\ApiCoreBundle\Domain\Context"/>

            <tag name="endpoint.target" channel="redirects" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\StreamService">
            <argument type="tagged" tag="frontend.streamHandler" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\StreamHandler\ProductList">
            <argument type="service" id="frontastic.catwalk.product_api" />

             <tag name="frontend.streamHandler"/>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\StreamHandler\Product">
            <argument type="service" id="frontastic.catwalk.product_api" />

             <tag name="frontend.streamHandler"/>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\StreamHandler\ContentList">
            <argument type="service" id="frontastic.catwalk.content_api" />

             <tag name="frontend.streamHandler"/>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\StreamHandler\Content">
            <argument type="service" id="frontastic.catwalk.content_api" />

             <tag name="frontend.streamHandler"/>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\StreamHandler\AccountAddresses">
            <argument type="service" id="frontastic.catwalk.account_api" />

             <tag name="frontend.streamHandler"/>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\StreamHandler\AccountOrders">
            <argument type="service" id="frontastic.catwalk.cart_api" />

             <tag name="frontend.streamHandler"/>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\StreamHandler\AccountWishlists">
            <argument type="service" id="frontastic.catwalk.wishlist_api" />

             <tag name="frontend.streamHandler"/>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\TasticFieldService">
            <argument type="service" id="Frontastic\Catwalk\ApiCoreBundle\Domain\TasticService" />
            <argument type="tagged" tag="frontend.tasticFieldHandler" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\TasticFieldHandler\TreeFieldHandler" class="Frontastic\Catwalk\FrontendBundle\Domain\TasticFieldHandler\TreeFieldHandler">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\NodeService" />

             <tag name="frontend.tasticFieldHandler"/>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\TasticFieldHandler\AccountWishlistsFieldHandler" class="Frontastic\Catwalk\FrontendBundle\Domain\TasticFieldHandler\AccountWishlistsFieldHandler">
            <argument type="service" id="frontastic.catwalk.wishlist_api" />
            <argument type="service" id="Frontastic\Catwalk\ApiCoreBundle\Domain\Context" />

             <tag name="frontend.tasticFieldHandler"/>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\ViewDataProvider">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\StreamService" />
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\TasticFieldService" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\LayoutService">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Gateway\LayoutGateway" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\RenderService">
            <argument type="service" id="Frontastic\Catwalk\ApiCoreBundle\Domain\ContextService" />
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\RenderService\ResponseDecorator" />
            <argument type="service">
                <service class="Frontastic\Common\HttpClient\StatsD">
                    <argument>catwalk.node</argument>
                    <argument type="service" id="Domnikl\Statsd\Client"/>
                    <argument type="service" id="Frontastic\Common\HttpClient\Stream" />
                </service>
            </argument>
            <argument>%frontastic.nodejs.renderer%</argument>
            <argument type="service" id="Frontastic\Common\JsonSerializer" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\PageImpressionRecorder">
            <argument type="service" id="Domnikl\Statsd\Client" />

             <tag name="kernel.event_listener" event="kernel.terminate" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\RenderService\ResponseDecorator">
             <tag name="kernel.event_listener" event="kernel.response" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\PreviewService">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Gateway\PreviewGateway" />
        </service>

        <service id="Frontastic\Common\ProductApiBundle\Domain\ProductApi" alias="frontastic.catwalk.product_api" />

        <service id="frontastic.catwalk.product_api" class="Frontastic\Common\ProductApiBundle\Domain\ProductApi">
            <factory
                service="Frontastic\Common\ProductApiBundle\Domain\ProductApiFactory"
                method="factor" />
            <argument type="expression">service('Frontastic\\Catwalk\\ApiCoreBundle\\Domain\\Context').customer</argument>
        </service>

        <service id="frontastic.catwalk.content_api" class="Frontastic\Common\ContentApiBundle\Domain\ContentApi">
            <factory
                service="Frontastic\Common\ContentApiBundle\Domain\ContentApiFactory"
                method="factor" />
            <argument type="expression">service('Frontastic\\Catwalk\\ApiCoreBundle\\Domain\\Context').customer</argument>
        </service>

        <service id="frontastic.catwalk.cart_api" class="Frontastic\Common\AccountApiBundle\Domain\CartApi">
            <factory
                service="Frontastic\Common\CartApiBundle\Domain\CartApiFactory"
                method="factor" />
            <argument type="expression">service('Frontastic\\Catwalk\\ApiCoreBundle\\Domain\\Context').customer</argument>
        </service>

        <service id="frontastic.catwalk.account_api" class="Frontastic\Common\AccountApiBundle\Domain\AccountApi">
            <factory
                service="Frontastic\Common\AccountApiBundle\Domain\AccountApiFactory"
                method="factor" />
            <argument type="expression">service('Frontastic\\Catwalk\\ApiCoreBundle\\Domain\\Context').customer</argument>
        </service>

        <service id="frontastic.catwalk.wishlist_api" class="Frontastic\Common\WishlistApiBundle\Domain\WishlistApi">
            <factory
                service="Frontastic\Common\WishlistApiBundle\Domain\WishlistApiFactory"
                method="factor" />
            <argument type="expression">service('Frontastic\\Catwalk\\ApiCoreBundle\\Domain\\Context').customer</argument>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\RouteService">
            <argument>%kernel.cache_dir%</argument>
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Routing\Loader">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\RouteService" />

            <tag name="routing.loader" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Gateway\NodeGateway">
            <argument type="service">
                <service class="Doctrine\ORM\DocumentRepository">
                    <factory service="doctrine.orm.default_entity_manager"
                        method="getRepository" />
                    <argument>Frontastic\Catwalk\FrontendBundle\Domain\Node</argument>
                </service>
            </argument>
            <argument type="service" id="doctrine.orm.entity_manager" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Gateway\PageGateway">
            <argument type="service">
                <service class="Doctrine\ORM\DocumentRepository">
                    <factory service="doctrine.orm.default_entity_manager"
                        method="getRepository" />
                    <argument>Frontastic\Catwalk\FrontendBundle\Domain\Page</argument>
                </service>
            </argument>
            <argument type="service" id="doctrine.orm.entity_manager" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Gateway\MasterPageMatcherRulesGateway">
            <argument type="service">
                <service class="Doctrine\ORM\DocumentRepository">
                    <factory service="doctrine.orm.default_entity_manager"
                             method="getRepository" />
                    <argument>Frontastic\Catwalk\FrontendBundle\Domain\MasterPageMatcherRules</argument>
                </service>
            </argument>
            <argument type="service" id="doctrine.orm.entity_manager" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Gateway\LayoutGateway">
            <argument type="service">
                <service class="Doctrine\ORM\DocumentRepository">
                    <factory service="doctrine.orm.default_entity_manager"
                        method="getRepository" />
                    <argument>Frontastic\Catwalk\FrontendBundle\Domain\Layout</argument>
                </service>
            </argument>
            <argument type="service" id="doctrine.orm.entity_manager" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Gateway\PreviewGateway">
            <argument type="service">
                <service class="Doctrine\ORM\DocumentRepository">
                    <factory service="doctrine.orm.default_entity_manager"
                        method="getRepository" />
                    <argument>Frontastic\Catwalk\FrontendBundle\Domain\Preview</argument>
                </service>
            </argument>
            <argument type="service" id="doctrine.orm.entity_manager" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Gateway\FacetGateway">
            <argument type="service">
                <service class="Doctrine\ORM\DocumentRepository">
                    <factory service="doctrine.orm.default_entity_manager"
                             method="getRepository" />
                    <argument>Frontastic\Catwalk\FrontendBundle\Domain\Facet</argument>
                </service>
            </argument>
            <argument type="service" id="doctrine.orm.entity_manager" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Gateway\RedirectGateway">
            <argument type="service">
                <service class="Doctrine\ORM\DocumentRepository">
                    <factory service="doctrine.orm.default_entity_manager"
                             method="getRepository" />
                    <argument>Frontastic\Catwalk\FrontendBundle\Domain\Redirect</argument>
                </service>
            </argument>
            <argument type="service" id="doctrine.orm.entity_manager" />
        </service>

        <service id="Aptoma\Twig\Extension\MarkdownExtension">
            <argument type="service">
                <service class="Aptoma\Twig\Extension\MarkdownEngine\MichelfMarkdownEngine" />
            </argument>

            <tag name="twig.extension" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Twig\RenderExtension">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\RenderService" />

            <tag name="twig.extension" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Twig\ContextExtension">
            <!--
             * IMPORTANT: We must use the container here, otherwise we try to load
             * the ContextService in context free situations.
            -->
            <argument type="service" id="service_container" />

            <tag name="twig.extension" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Twig\NodeExtension">
            <!--
             * IMPORTANT: We must use the container here, otherwise we try to load
             * the ContextService in context free situations.
            -->
            <argument type="service" id="service_container" />
            <argument type="service" id="cache.app.simple" />

            <tag name="twig.extension" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Twig\AssetExtension">
            <tag name="twig.extension" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Twig\JsonExtension">
            <argument type="service" id="Frontastic\Common\JsonSerializer" />

            <tag name="twig.extension" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\EventListener\RedirectListener">
            <argument type="service" id="Frontastic\Catwalk\FrontendBundle\Domain\RedirectService" />

            <tag name="kernel.event_listener" event="kernel.exception" priority="10" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\EventListener\MissingHomepageRouteListener">
            <argument type="service" id="Symfony\Component\Templating\EngineInterface" />
            <argument>%kernel.debug%</argument>

            <tag name="kernel.event_listener" event="kernel.exception" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\EventListener\RebuildRoutesListener">
            <argument type="service" id="Symfony\Component\DependencyInjection\ContainerInterface" />
            <argument type="service" id="Psr\Log\LoggerInterface" />

            <tag name="kernel.event_listener" event="kernel.request" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\EventListener\ReferrerPolicy">
            <argument type="service" id="Frontastic\Catwalk\ApiCoreBundle\Domain\Context"/>

            <tag name="kernel.event_listener" event="kernel.response" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\EventListener\ContentSecurityPolicy">
            <argument type="service" id="Frontastic\Catwalk\ApiCoreBundle\Domain\Context"/>

            <tag name="kernel.event_listener" event="kernel.response" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\FeatureFlagService">
            <argument type="service" on-invalid="null">
                <service class="Frontastic\Catwalk\ApiCoreBundle\Domain\DataRepository">
                    <factory service="Frontastic\Catwalk\ApiCoreBundle\Domain\AppRepositoryService"
                        method="getRepository" />
                    <argument>FeatureFlag</argument>
                </service>
            </argument>

            <tag name="context.decorator" />
        </service>

        <service id="Frontastic\Catwalk\FrontendBundle\Domain\SitemapService">
            <argument type="tagged" tag="frontend.sitemapExtension" />
        </service>
    </services>
</container>
